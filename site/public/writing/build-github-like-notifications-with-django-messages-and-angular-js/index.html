

<!DOCTYPE html>
<html lang="en">
    <head>
  <meta charset="utf-8">
  <title> Build GitHub like notifications with Django messages and AngularJS &middot; /dev/ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://dev.pippi.im//css/bootstrap.min.css" media="screen">
  <link rel="stylesheet" href="http://dev.pippi.im//css/dev.css">
  <link href="http://dev.pippi.im//css/font-awesome.min.css" rel="stylesheet">
  
  
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">
  
  <link href="" rel="alternate" type="application/rss+xml" title="/dev/" />
</head>

    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a href="/" class="navbar-brand">/dev/ by Massimiliano Pippi</a>
    </div>
    <div class="navbar-collapse collapse" id="navbar-main">
      <ul class="nav navbar-nav">
        
      </ul>
    </div>
  </div>
</div>
        <div class="container">
            <h1>Build GitHub like notifications with Django messages and AngularJS</h1>
            <h5 id="wc"> 1500 words by masci</h5>
            <div class="row">
                <div class="post col-lg-8">
                    

<h2 id="foreword">Foreword</h2>

<p>GitHub has a very nice notification system, very similar to a plain old email inbox. You receive a notification which
remains <em>unread</em> until you actually read it; then it&rsquo;s archived and removed from your <em>inbox</em>, which it happens could remain empty:</p>

<p><img src="/images/github_notifications.png" alt="github inbox" /></p>

<p>For those who don&rsquo;t know, Django ships a library for displaying &ldquo;one-time&rdquo; messages to the users, it&rsquo;s called <em>Message
Framework</em> and you can find it in the <code>contrib</code> package. Messages are <em>produced</em> during users&rsquo; activity and delivered
subsequently; in the meantime, they are stored in cookies or sessions.</p>

<p>The ephemeral nature of Django&rsquo;s <code>contrib.messages</code> makes them not suitable for storing notifications in GitHub
style: notifications have to be persisted until user actually reads it, messages instead are marked as read the moment
they are, let&rsquo;s say, <em>observed</em>. Nevertheless Django message framework is flexible enough to let you provide your own
storage policy, and third-party applications like <a href="https://github.com/evonove/django-stored-messages">Django Stored Messages</a>
use this feature to store messages in a persistent way (specifically, an sql database).</p>

<blockquote>
<p>Disclaimer: The frontend code will make use of AngularJs even if I am a total newbie and I don&rsquo;t really know how to
angular. If you are a newbie too, please go read <a href="http://toddmotto.com/ultimate-guide-to-learning-angular-js-in-one-day/">this effective blog post</a>
by Todd Motto and then come back here. If you&rsquo;re not an Angular newbie, please take into account my code could offend
you.</p>
</blockquote>

<h2 id="the-application">The application</h2>

<p>Fire up a virtualenv and install Django:</p>

<pre><code>mkvirtualenv notification_example
pip install django
</code></pre>

<p>Start an empty project:</p>

<pre><code>django-admin.py startproject notification_example
</code></pre>

<p>&hellip;and an app:</p>

<pre><code>cd notification_example
python manage.py startapp notification
</code></pre>

<p>Now for some dependencies - install Django Stored Messages and <a href="http://http://django-rest-framework.org/">Django Rest Framework</a>:</p>

<pre><code>pip install django-stored-messages djangorestframework
</code></pre>

<p>Configure all the things! In <code>notification_example/settings.py</code> be sure to have these:</p>

<pre><code>PROJECT_ROOT = os.path.join(os.path.abspath(os.path.dirname(__file__)), '..')

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(PROJECT_ROOT, 'db.sqlite'),
    }
}

INSTALLED_APPS = (
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.sites',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'notification',
    'stored_messages',
    'rest_framework',
)

MESSAGE_STORAGE = 'stored_messages.storage.PersistentStorage'
</code></pre>


<p>Now let&rsquo;s go for some views. We will provide a view to serve the homepage, plus a view to show messages for the current
logged in user.</p>

<h2 id="the-homepage-view">The homepage view</h2>

<p>Django Stored Messages can persist messages only when they are sent to a valid user, and such user has to login for
viewing the messages, so we provide a login form directly inside the homepage. To produce some notifications, visiting the index will trigger a message as well. The code:</p>

<pre><code>from django.views.generic import FormView
from django.contrib.auth.forms import AuthenticationForm
from django.contrib.messages import add_message
from django.contrib.auth import login

import stored_messages

class IndexView(FormView):
    template_name = 'notification/homepage.html'
    form_class = AuthenticationForm
    success_url = '/'

    def get_context_data(self, **kwargs):
        add_message(self.request, stored_messages.STORED_INFO, 'You visited the homepage')
        return super(IndexView, self).get_context_data(**kwargs)

    def form_valid(self, form):
        login(self.request, form.get_user())
        return super(IndexView, self).form_valid(form)
</code></pre>


<p>We&rsquo;re going to use <em>class based views</em>, of course. Notice Django Stored Messages let us make use of the builtin
messages api, thus passing in a message of type <code>stored_messages.STORED_INFO</code> will cause that message to be stored on
the database.
The <a href="https://github.com/masci/notification_example/blob/master/templates/notification/homepage.html">homepage template</a>
will be extended from a <a href="https://github.com/masci/notification_example/blob/master/templates/base.html">basic Boostrap3 template</a>, we&rsquo;re going onto details later.</p>

<h2 id="the-message-view">The message view</h2>

<p>This is a simple <code>TemplateView</code>, the only trick here is getting from the urlstring whether user wants to see all the
notifications or only the <em>unread</em> ones:</p>

<pre><code>from django.views.generic import TemplateView

class MessagesView(TemplateView):
    template_name = 'notification/messages.html'

    def get(self, request, *args, **kwargs):
        if 'unread' in request.GET:  # quick and dirty
            kwargs['unread'] = True
        return super(MessagesView, self).get(request, *args, **kwargs)
</code></pre>


<p>The view code is rather simple because all the magic is left to Django Stored Messages template tags and its REST api.
The Html template for the message view will try to mimic GitHub&rsquo;s notification page,
<a href="https://github.com/masci/notification_example/blob/master/templates/notification/messages.html">here is the code</a> and
this is the result:</p>

<p><img src="/images/messages.png" alt="messages screenshot" /></p>

<p>As you can see from this chunk:</p>

<pre><code><div class="col-md-9">
{% if not unread %}
    {% stored_messages_archive 100 %}
{% else %}
    ...
{% endif %}
</div>
</code></pre>


<p>If user requested the archive (i.e. to show messages that were already read), the template tag
<code>stored_messages_archive</code> provided by Django Stored Messages will show a list of <code>100</code> messages rendering
the template at <code>stored_messages/stored_messages_list.html</code>. Here is the template ovverrided to add Bootstrap3 classes:</p>

<pre><code>{% if messages %}
    <ul class="list-group">
        {% for message in messages %}
            <li class="list-group-item">
                {{ message.message }}
            </li>
        {% empty %}
            <li class="list-group-item">No messages here!</li>
        {% endfor %}
    </ul>
{% endif %}
</code></pre>


<p>We will get into the details for the <code>else</code> branch in the messages template later.</p>

<h2 id="plug-the-urls">Plug the urls</h2>

<p>Nothing special here but notice the inclusion of the REST api urls coming from <code>stored_messages</code> package:</p>

<pre><code>urlpatterns = patterns('',
    url(r'^logout/$', 'django.contrib.auth.views.logout',  {'next_page': '/'}, name='logout'),
    url(r'^$', IndexView.as_view(), name='home'),
    url(r'^messages/$', MessagesView.as_view(), name='messages'),
    url(r'^api/', include('stored_messages.urls')),
)
</code></pre>


<h2 id="final-touches">Final touches</h2>

<p>To add some noise to the notification stream, we will add messages for the user when she logs in and out:</p>

<pre><code>def _user_logged_in(*args, **kwargs):
    add_message(kwargs['request'], stored_messages.STORED_INFO, 'You were logged in!')
user_logged_in.connect(_user_logged_in)


def _user_logged_out(*args, **kwargs):
    add_message(kwargs['request'], stored_messages.STORED_INFO, 'You were logged out!')
user_logged_out.connect(_user_logged_out)
</code></pre>


<p>The Django app is complete now, time for some Javascript code!</p>

<h2 id="the-rest">The REST</h2>

<p>Even if Django Stored Messages has a template tag to show unread messages, for this demo we will use the REST api,
which let us retrieve unread messages and mark them as read. To interact with the api we use
<a href="http://angularjs.org/">Angular</a>, for the sake of simplicity we use a single controller:</p>

<pre><code>var messageApp = angular.module('messageApp', []);

messageApp.controller('MainCtrl', ['$scope', '$http', function ($scope, $http) {
    // Messages array
    $scope.messages = {};

    // ...
}]);
</code></pre>


<p>Notice the injection of the <code>$http</code> object we will use to make http requests. The messages array will be filled with
data coming from the api, then it will be available through the <code>$scope</code> object. For the angular application to work
properly, the html code in our templates needs to be aware of the angular stuff - we do this in the <code>base.html</code> so that
every page could use angular facilities:</p>

<pre><code><!DOCTYPE html>
<html ng-app="messageApp">
    <head>
    ...
</code></pre>


<p>and:</p>

<pre><code>...
</head>

<body ng-controller="MainCtrl">
    <!-- navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top">
    ...
</code></pre>


<p>Inside the controller, this code will be added to retrieve all the unread messages for the logged-in user:</p>

<pre><code>// ...

// retrieve Messages from the restAPI
$http({
    method: 'GET',
    url: '//127.0.0.1:8000/api/inbox/'
})
.success(function (data, status, headers, config) {
    $scope.messages = data;
})
.error(function (data, status, headers, config) {
    // something went wrong :(
});

// ...
</code></pre>


<p>If everything goes fine, <code>$scope.messages</code> will contain our messages and we can use them inside the DOM. To do this, we
need some angularities inside the html, for example in the <code>message.html</code> template:</p>

<pre><code>{% verbatim %}
<ul class="list-group" ng-if="messages.length">
  <li class="list-group-item" ng-repeat="message in messages">
    {{ message.message.date | date:'MMM d, y h:mm:ss a' }} - {{ message.message.message }}
      <a ng-click="markRead($index)" style="cursor:pointer">Mark as read</a>
  </li>
</ul>
{% endverbatim %}
</code></pre>


<p>The <code>ng-if</code> attribute determines if we have some messages to show. If we do have, the <code>ng-repeat</code> attribute will take
care of iterating the messages and show them in the DOM through angular&rsquo;s template tags.</p>

<blockquote>
<p>Warning: we&rsquo;re mixing Django and Angular templates there and since they share the same template syntax (this could
be changed in angular but it&rsquo;s not generally advisable) we need to wrap angular code inside Django&rsquo;s <code>verbatim</code> tags.</p>
</blockquote>

<p>In the html code above notice this:
<pre><code><a ng-click="markRead($index)" style="cursor:pointer">Mark as read</a>
</code></pre>
</p>

<p>For every unread message, we provide a link and we tell angular that when user clicks it (<code>ng-click</code> attribute) the
function <code>markRead()</code> has to be called with the parameter <code>$index</code>. We define that function inside the angular
controller and attach it to the <code>$scope</code>:</p>

<pre><code>// ...

// mark messages read
$scope.markRead = function (index) {
    var id = $scope.messages[index].id;
    $http({
        method: 'POST',
        url: '//127.0.0.1:8000/api/inbox/'+id+'/read/',
        xsrfHeaderName: 'X-CSRFToken',
        xsrfCookieName: 'csrftoken'
    })
    .success(function (data, status, headers, config) {
        $scope.messages.splice(index, 1);
    })
    .error(function (data, status, headers, config) {
        // something went wrong :(
    })
};
// ...
</code></pre>


<p>The parameter passed to <code>$http</code> contains all the logic needed to retrieve the csrf token from user&rsquo;s cookie and pass it
to Django inside the <code>X-CSRFToken</code> header. For my experience, I&rsquo;ve never seen an easier way to do this (thank you so
much, Angular!). After retrieving the database id for the <em>index-th</em> message, we call the <code>/api/inbox/{lookup}/read/</code>
endpoint which marks that message as read. In case the request goes well (and this is where magics happen), we remove
the element from the <code>$scope.messages</code> - angular will remove that element from the DOM afterwards. No code. No explicit
DOM manipulation. Just fun.</p>

<p>Since Django Stored Messages api exposes an endpoint to mark all messages read, we provide a button to do exactly this.
The code for the button is very similar to the one to mark messages read:</p>

<pre><code><button type="button" class="btn btn-success" ng-click="markAllRead()">Mark all read</button>
</code></pre>


<p>This time the function name is <code>markAllRead</code> and we call it without parameters; the function is defined inside the
controller:</p>

<pre><code>// ...

// mark all read
$scope.markAllRead = function () {
    $http({
        method: 'POST',
        url: '//127.0.0.1:8000/api/mark_all_read/',
        xsrfHeaderName: 'X-CSRFToken',
        xsrfCookieName: 'csrftoken'
    })
    .success(function(data, status, headers, config) {
        $scope.messages.splice(0, $scope.messages.length);
    })
    .error(function(data, status, headers, config){
        // something went wrong :(
    })
};
// ...
</code></pre>


<p>The csrf boilerplate is the same (for the record, this could be easily avoided using some advanced angular features)
and the logic is very similar: in case the request succeeded, the array of messages is cleared and the DOM reflects the
changes automagically.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://github.com/masci/notification_example">A working example is on GitHub</a></li>
<li><a href="http://django-stored-messages.rtfd.org/">Django Stored Messages documentation</a></li>
</ul>

                    <hr>
                    <ul class="pager">
                         &nbsp;<li class="previous"><a href="http://dev.pippi.im/writing/stop-asking-users-for-passwords-and-let-oauth2-do/"> Prev</a></li>
                         &nbsp;<li class="next"><a href="http://dev.pippi.im/writing/moving-to-jekyll/"> Next</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <div class="list-group voffset4">
                        <div class="list-group-item">
                            <h4 class="list-group-item-heading">POSTED</h4>
                            <p class="list-group-item-text">Tue, Oct 22, 2013</p>
                        </div>
                        <div class="list-group-item">
                            <h4 class="list-group-item-heading">TAGS</h4>
                            
                            <a href="http://dev.pippi.im//tags/django">django</a>
                            
                            <a href="http://dev.pippi.im//tags/python">python</a>
                            
                            <a href="http://dev.pippi.im//tags/angularjs">angularjs</a>
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="post col-lg-8 voffset4">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'dev-pippi';
    var disqus_identifier = 'http:\/\/dev.pippi.im\/writing\/build-github-like-notifications-with-django-messages-and-angular-js\/';
    var disqus_title = 'Build GitHub like notifications with Django messages and AngularJS';
    var disqus_url = 'http:\/\/dev.pippi.im\/writing\/build-github-like-notifications-with-django-messages-and-angular-js\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
            <footer>
  <div class="row">
    <div class="col-lg-12">
      <hr>
      <small>
        <ul class="list-unstyled">
          <li class="pull-right"><a href="#top">Back to top</a></li>
        </ul>
        <p>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a><br />Contents licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        </p>
        <p>
          Original theme by <a href="http://thomaspark.me" rel="nofollow">Thomas Park</a>,
          code released under the <a href="https://github.com/masci/dev/blob/master/LICENSE">MIT License</a>.
        </p>
      </small>
    </div>
  </div>
</footer>
        </div>
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43125807-1', 'auto');
  ga('send', 'pageview');

</script>
    </body>
</html>
