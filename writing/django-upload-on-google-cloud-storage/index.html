

<!DOCTYPE html>
<html lang="en">
    <head>
  <meta charset="utf-8">
  <title> Uploading files to Google Cloud Storage with Django &middot; /dev/ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://dev.pippi.im//css/bootstrap.min.css" media="screen">
  <link rel="stylesheet" href="http://dev.pippi.im//css/dev.css">
  <link href="http://dev.pippi.im//css/font-awesome.min.css" rel="stylesheet">
  
  
  
  <link href="" rel="alternate" type="application/rss+xml" title="/dev/" />
</head>

    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a href="/" class="navbar-brand">/dev/ by Massimiliano Pippi</a>
    </div>
    <div class="navbar-collapse collapse" id="navbar-main">
      <ul class="nav navbar-nav">
        
      </ul>
    </div>
  </div>
</div>
        <div class="container">
            <h1>Uploading files to Google Cloud Storage with Django</h1>
            <h5 id="wc"> 500 words by masci</h5>
            <div class="row">
                <div class="post col-lg-8">
                    

<h2 id="intro">Intro</h2>

<p>On of the features of <a href="https://github.com/masci/django-appengine-toolkit">Django Appengine Toolkit</a> is simplifying
the work needed to configure Google Cloud Storage as a static files storage for Django applications running on
Google App Engine. Infact all you have to do is writing something like this in your settings.py module:</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#555">&lt;</span>pre<span style="color:#555">&gt;&lt;</span>code<span style="color:#555">&gt;</span>APPENGINE_TOOLKIT <span style="color:#555">=</span> {
    <span style="color:#c30">&#39;APP_YAML&#39;</span>: os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(BASE_DIR, <span style="color:#c30">&#39;app.yaml&#39;</span>),
    <span style="color:#c30">&#39;BUCKET_NAME&#39;</span>: <span style="color:#c30">&#39;media-uploads&#39;</span>,
}
DEFAULT_FILE_STORAGE <span style="color:#555">=</span> <span style="color:#c30">&#39;appengine_toolkit.storage.GoogleCloudStorage&#39;</span>
STATICFILE_STORAGE <span style="color:#555">=</span> <span style="color:#c30">&#39;appengine_toolkit.storage.GoogleCloudStorage&#39;</span>
<span style="color:#555">&lt;/</span>code<span style="color:#555">&gt;&lt;/</span>pre<span style="color:#555">&gt;</span></code></pre></div>

<h2 id="a-complete-example">A complete example</h2>

<p><a href="https://github.com/masci/django_cloudstorage_example">This repo</a> contains a minimalistic Django project
implementing a file storage application that lets users upload, listing, retrieve and delete files. The project has just
one app implementing all the logic, defining the model and exposing the views. For detailed instructions on how to
setup a Django project on App Engine with <code>django-appengine-toolkit</code> please check out
<a href="http://dev.pippi.im/2014/02/10/create-a-blog-in-minutes-on-app-engine-with-django/">this blog post</a>.
Now let&rsquo;s take a look at the code.</p>

<h3 id="the-model">The Model</h3>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#555">&lt;</span>pre<span style="color:#555">&gt;&lt;</span>code<span style="color:#555">&gt;</span><span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">Document</span>(models<span style="color:#555">.</span>Model):
    docfile <span style="color:#555">=</span> models<span style="color:#555">.</span>FileField(upload_to<span style="color:#555">=</span><span style="color:#c30">&#39;documents/%Y/%m/</span><span style="color:#a00">%d</span><span style="color:#c30">&#39;</span>)

    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">delete</span>(self, <span style="color:#555">*</span>args, <span style="color:#555">**</span>kwargs):
        storage, path <span style="color:#555">=</span> self<span style="color:#555">.</span>docfile<span style="color:#555">.</span>storage, self<span style="color:#555">.</span>docfile<span style="color:#555">.</span>path
        <span style="color:#366">super</span>(Document, self)<span style="color:#555">.</span>delete(<span style="color:#555">*</span>args, <span style="color:#555">**</span>kwargs)
        storage<span style="color:#555">.</span>delete(path)
<span style="color:#555">&lt;/</span>code<span style="color:#555">&gt;&lt;/</span>pre<span style="color:#555">&gt;</span></code></pre></div>

<p>Pretty easy, we have just one field containing the file. Notice the delete method we&rsquo;re going to use so that
when an instance is deleted, the same will happen to corresponding file on Cloud Storage.</p>

<h3 id="the-views">The views</h3>

<p>Hail to the Class Based Views! Look at how few lines of code we need for the main view, implementing the listing and
the logic for the uploads, form included:</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#555">&lt;</span>pre<span style="color:#555">&gt;&lt;</span>code<span style="color:#555">&gt;</span><span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">FileManagerView</span>(CreateView):
    model <span style="color:#555">=</span> Document
    success_url <span style="color:#555">=</span> reverse_lazy(<span style="color:#c30">&#39;main&#39;</span>)

    <span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">get_context_data</span>(self, <span style="color:#555">**</span>kwargs):
        kwargs[<span style="color:#c30">&#39;object_list&#39;</span>] <span style="color:#555">=</span> Document<span style="color:#555">.</span>objects<span style="color:#555">.</span><span style="color:#366">all</span>()
        kwargs[<span style="color:#c30">&#39;fava&#39;</span>] <span style="color:#555">=</span> <span style="color:#c30">&#39;rava&#39;</span>
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">super</span>(FileManagerView, self)<span style="color:#555">.</span>get_context_data(<span style="color:#555">**</span>kwargs)
<span style="color:#555">&lt;/</span>code<span style="color:#555">&gt;&lt;/</span>pre<span style="color:#555">&gt;</span></code></pre></div>

<p>Since we need to show the list of files <strong>and</strong> the form to upload them on the same page, we cannot use a <code>CreateView</code> as is,
what we need is a <code>CreateView</code> and <code>ListView</code> hybrid instead, thus the hack of overriding <code>get_context_data</code>: we inject the queryset
in the context so the template can render properly.</p>

<p>The relevant html code in the template looks like this:</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#309;font-weight:bold">pre</span>&gt;&lt;<span style="color:#309;font-weight:bold">code</span>&gt;<span style="color:#999;font-weight:bold">&amp;lt;</span>ul<span style="color:#999;font-weight:bold">&amp;gt;</span>
{% for object in object_list %}
  <span style="color:#999;font-weight:bold">&amp;lt;</span>li<span style="color:#999;font-weight:bold">&amp;gt;</span>
    <span style="color:#999;font-weight:bold">&amp;lt;</span>form action=<span style="color:#999;font-weight:bold">&amp;quot;</span>{% url &#39;delete&#39; object.id %}<span style="color:#999;font-weight:bold">&amp;quot;</span> method=<span style="color:#999;font-weight:bold">&amp;quot;</span>post<span style="color:#999;font-weight:bold">&amp;quot;&amp;gt;</span>{% csrf_token %}
      <span style="color:#999;font-weight:bold">&amp;lt;</span>a href=<span style="color:#999;font-weight:bold">&amp;quot;</span>{{ object.docfile.url }}<span style="color:#999;font-weight:bold">&amp;quot;&amp;gt;</span>{{ object.docfile.name }}<span style="color:#999;font-weight:bold">&amp;lt;</span>/a<span style="color:#999;font-weight:bold">&amp;gt;</span>
      <span style="color:#999;font-weight:bold">&amp;lt;</span>input type=<span style="color:#999;font-weight:bold">&amp;quot;</span>submit<span style="color:#999;font-weight:bold">&amp;quot;</span> value=<span style="color:#999;font-weight:bold">&amp;quot;</span>Delete<span style="color:#999;font-weight:bold">&amp;quot;</span> /<span style="color:#999;font-weight:bold">&amp;gt;</span>
    <span style="color:#999;font-weight:bold">&amp;lt;</span>/form<span style="color:#999;font-weight:bold">&amp;gt;</span>
  <span style="color:#999;font-weight:bold">&amp;lt;</span>/li<span style="color:#999;font-weight:bold">&amp;gt;</span>
{% empty %}
  <span style="color:#999;font-weight:bold">&amp;lt;</span>li<span style="color:#999;font-weight:bold">&amp;gt;</span>No documents.<span style="color:#999;font-weight:bold">&amp;lt;</span>/li<span style="color:#999;font-weight:bold">&amp;gt;</span>
{% endfor %}
<span style="color:#999;font-weight:bold">&amp;lt;</span>/ul<span style="color:#999;font-weight:bold">&amp;gt;</span>

<span style="color:#999;font-weight:bold">&amp;lt;</span>form  enctype=<span style="color:#999;font-weight:bold">&amp;quot;</span>multipart/form-data<span style="color:#999;font-weight:bold">&amp;quot;</span> action=<span style="color:#999;font-weight:bold">&amp;quot;&amp;quot;</span> method=<span style="color:#999;font-weight:bold">&amp;quot;</span>post<span style="color:#999;font-weight:bold">&amp;quot;&amp;gt;</span>{% csrf_token %}
    {{ form.as_p }}
    <span style="color:#999;font-weight:bold">&amp;lt;</span>input type=<span style="color:#999;font-weight:bold">&amp;quot;</span>submit<span style="color:#999;font-weight:bold">&amp;quot;</span> value=<span style="color:#999;font-weight:bold">&amp;quot;</span>Upload<span style="color:#999;font-weight:bold">&amp;quot;</span> /<span style="color:#999;font-weight:bold">&amp;gt;</span>
<span style="color:#999;font-weight:bold">&amp;lt;</span>/form<span style="color:#999;font-weight:bold">&amp;gt;</span>
&lt;/<span style="color:#309;font-weight:bold">code</span>&gt;&lt;/<span style="color:#309;font-weight:bold">pre</span>&gt;</code></pre></div>

<p>Notice we render a form for each file listed, so we can make a <code>POST</code> request directly, without passing for a confirmation view
as usual when using <code>DeleteView</code> generics. Let&rsquo;s see the View code:</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#555">&lt;</span>pre<span style="color:#555">&gt;&lt;</span>code<span style="color:#555">&gt;</span><span style="color:#069;font-weight:bold">class</span> <span style="color:#0a8;font-weight:bold">FileRemoveView</span>(DeleteView):
    model <span style="color:#555">=</span> Document
    success_url <span style="color:#555">=</span> reverse_lazy(<span style="color:#c30">&#39;main&#39;</span>)
<span style="color:#555">&lt;/</span>code<span style="color:#555">&gt;&lt;/</span>pre<span style="color:#555">&gt;</span></code></pre></div>

<p>Ok, this was short. Basically we only need to tell to the class based view which is the model and where to go once the istance
is deleted. Wow.</p>

<h3 id="the-urls">The urls</h3>

<p>Quick and dirty: mount the two views to the urls:</p>

<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#555">&lt;</span>pre<span style="color:#555">&gt;&lt;</span>code<span style="color:#555">&gt;</span>urlpatterns <span style="color:#555">=</span> patterns(<span style="color:#c30">&#39;&#39;</span>,
    url(<span style="color:#c30">r</span><span style="color:#c30">&#39;^$&#39;</span>, FileManagerView<span style="color:#555">.</span>as_view(), name<span style="color:#555">=</span><span style="color:#c30">&#39;main&#39;</span>),
    url(<span style="color:#c30">r</span><span style="color:#c30">&#39;^delete/(?P&amp;lt;pk&amp;gt;\d+)/$&#39;</span>, FileRemoveView<span style="color:#555">.</span>as_view(), name<span style="color:#555">=</span><span style="color:#c30">&#39;delete&#39;</span>),
)   
<span style="color:#555">&lt;/</span>code<span style="color:#555">&gt;&lt;/</span>pre<span style="color:#555">&gt;</span></code></pre></div>

<p>That&rsquo;s all, have fun deploying on App Engine!</p>

                    <hr>
                    <ul class="pager">
                         &nbsp;<li class="previous"><a href="http://dev.pippi.im/writing/if-code-is-poetry-then-documentation-is-prose/"> Prev</a></li>
                         &nbsp;<li class="next"><a href="http://dev.pippi.im/talk/fullstack_angular_django/"> Next</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <div class="list-group voffset4">
                        <div class="list-group-item">
                            <h4 class="list-group-item-heading">POSTED</h4>
                            <p class="list-group-item-text">Fri, May 2, 2014</p>
                        </div>
                        <div class="list-group-item">
                            <h4 class="list-group-item-heading">TAGS</h4>
                            
                            <a href="http://dev.pippi.im//tags/django">django</a>
                            
                            <a href="http://dev.pippi.im//tags/google">google</a>
                            
                            <a href="http://dev.pippi.im//tags/python">python</a>
                            
                            <a href="http://dev.pippi.im//tags/appengine">appengine</a>
                            
                            <a href="http://dev.pippi.im//tags/gcs">gcs</a>
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="post col-lg-8 voffset4">
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dev-pippi" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
            <footer>
  <div class="row">
    <div class="col-lg-12">
      <hr>
      <small>
        <ul class="list-unstyled">
          <li class="pull-right"><a href="#top">Back to top</a></li>
        </ul>
        <p>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a><br />Contents licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        </p>
        <p>
          Original theme by <a href="http://thomaspark.me" rel="nofollow">Thomas Park</a>,
          code released under the <a href="https://github.com/masci/dev/blob/master/LICENSE">MIT License</a>.
        </p>
      </small>
    </div>
  </div>
</footer>
        </div>
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43125807-1', 'auto');
  ga('send', 'pageview');

</script>
    </body>
</html>
