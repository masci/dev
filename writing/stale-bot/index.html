<!doctype html>
<html lang="en-us">

<head>
  <title>Make a stale bot, learn GitHub Actions - /dev/ by Massimiliano Pippi</title>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.152.2">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Massimiliano Pippi" />
  <meta name="description" content="Make a stale bot, learn GitHub Actions" />
  <link rel="stylesheet" href="https://dev.pippi.im/css/main.min.66dc5ff1b2ffcc465c37385641ad836294f37f5f00dc4a10304ca1e7ad4f3979.css" />

  
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://dev.pippi.im/images/dominik-scythe-Sot0f3hQQ4Y-unsplash.jpg">
  <meta name="twitter:title" content="Make a stale bot, learn GitHub Actions">
  <meta name="twitter:description" content="A few months ago I had the chance to play with the first Beta of GitHub Actions but for some reasons it didn’t click for me: the point-and-click interface, the HCL syntax and the confusion in the market place put me back to my comfort zone, in the good company of the usual CI/CD systems we all have been using for years now.
Fast forward to a few weeks ago, when GitHub announced that Actions were finally approaching general availability; a couple of days later, my personal GitHub account was promptly enrolled in the Beta program. It was time to give it another try, and this is the story of my second attempt at learning Actions.">

  <meta property="og:url" content="https://dev.pippi.im/writing/stale-bot/">
  <meta property="og:site_name" content="/dev/ by Massimiliano Pippi">
  <meta property="og:title" content="Make a stale bot, learn GitHub Actions">
  <meta property="og:description" content="A few months ago I had the chance to play with the first Beta of GitHub Actions but for some reasons it didn’t click for me: the point-and-click interface, the HCL syntax and the confusion in the market place put me back to my comfort zone, in the good company of the usual CI/CD systems we all have been using for years now.
Fast forward to a few weeks ago, when GitHub announced that Actions were finally approaching general availability; a couple of days later, my personal GitHub account was promptly enrolled in the Beta program. It was time to give it another try, and this is the story of my second attempt at learning Actions.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="writing">
    <meta property="article:published_time" content="2019-09-22T15:53:40+02:00">
    <meta property="article:modified_time" content="2019-09-22T15:53:40+02:00">
    <meta property="article:tag" content="Github">
    <meta property="article:tag" content="Actions">
    <meta property="article:tag" content="Typescript">
    <meta property="og:image" content="https://dev.pippi.im/images/dominik-scythe-Sot0f3hQQ4Y-unsplash.jpg">


</head>

<body>
  <header class="app-header">
    <a href="https://dev.pippi.im/"><img class="app-header-avatar"
        src="/images/massi.png"
        alt="John Doe" /></a>
    <h1>/about/</h1>
    <p>
      Massi here. Software developer, engineering manager, I can ops.
    Open source advocate and contributor, documentation fanatic, speaker at conferences.
    I wrote a book once.
    </p>
    <div>
      See what I'm up to <a href="/now">now</a>.
    </div>
    <div class="app-header-social">
      
      <a target="_blank" href="https://github.com/masci"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
      
      <a target="_blank" href="http://www.linkedin.com/in/masci"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
      
    </div>
  </header>
  <main class="app-container">
    
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Make a stale bot, learn GitHub Actions</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Sep 22, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          11 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://dev.pippi.im/tags/github/">Github</a><a class="tag" href="https://dev.pippi.im/tags/actions/">Actions</a><a class="tag" href="https://dev.pippi.im/tags/typescript/">Typescript</a></div></div>
    </header>
    <div class="post-content">
      <p>A few months ago I had the chance to play with the first Beta of <a href="https://help.github.com/en/articles/about-github-actions">GitHub Actions</a>
but for some reasons it didn&rsquo;t click for me: the point-and-click interface, the
HCL syntax and the confusion in the market place put me back to my comfort zone,
in the good company of the usual CI/CD systems we all have been using for years now.</p>
<p>Fast forward to a few weeks ago, when GitHub announced that Actions were finally
approaching general availability; a couple of days later, my personal GitHub
account was promptly enrolled in the Beta program. It was time to give it another
try, and this is the story of my second attempt at learning Actions.</p>
<h2 id="introducing-the-stale-bot">Introducing the Stale Bot</h2>
<figure><img src="/images/dominik-scythe-Sot0f3hQQ4Y-unsplash.jpg" width="100%"><figcaption>
      <h4>Photo by Dominik Scythe on Unsplash</h4>
    </figcaption>
</figure>

<p>When I learn something new, it&rsquo;s vital for me to have some sort of prototype I
can change and evolve as I ramp up on the subject. That&rsquo;s why after few basic
experiments and a couple of easy projects ported from other CI/CD platforms, I
challenged myself to write a GitHub bot implemented in a single Workflow with
minimum recourse to 3rd party Actions.</p>
<p>The requirements are admittedly idiotic but they made a good excuse to learn
how to:</p>
<ul>
<li>use scheduled Workflows</li>
<li>execute jobs conditionally</li>
<li>interact with the GitHub API from a Workflow</li>
</ul>
<h2 id="requirements">Requirements</h2>
<p>A stale bot is an automated mechanism responsible for marking issues and pull
requests as &ldquo;stale&rdquo; when there&rsquo;s no activity around them after a given amount of
time. For the sake of simplicity, we&rsquo;ll limit the scope of the bot to issues
only.</p>
<p>The requirements are the following. For each issue on a GitHub repository:</p>
<ol>
<li>Apply the label <code>stale</code> after 30 days without any kind of activity,</li>
<li>remove the label <code>stale</code> when there&rsquo;s activity on the issue,</li>
<li>close the issue if it&rsquo;s been <code>stale</code> for more than 15 days.</li>
</ol>
<h2 id="create-the-workflow">Create the Workflow</h2>
<p>First of all, let&rsquo;s create a GitHub Workflow. You can do it from the GitHub UI
or by simply creating a yaml file under <code>.github/workflows/</code> at the root
of your repo. You might have different Workflows defined for a single repo and
the name of the file can be whatever, in my case it is <code>stalebot.yaml</code>. We also
have to give our Workflow a name that will be displayed in GitHub UI: let&rsquo;s call
it &ldquo;Stale Bot&rdquo;. Our yaml file will look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">name</span>: Stale Bot
</span></span></code></pre></div><h2 id="determine-when-the-workflow-has-to-run">Determine when the Workflow has to run</h2>
<p>We have to tell GitHub when we want to run our Workflow and we can do it with the
keyword <code>on</code>. According to our requirements, the Workflow should be triggered by
different events:</p>
<ul>
<li>Every night, to attach the <code>stale</code> label and to close issues that&rsquo;ve
been stale long enough.</li>
<li>Every time the issue is edited, or a label or milestone is attached.</li>
<li>Every time somebody leaves a comment on the issue.</li>
</ul>
<p>To run a Workflow periodically at a given time, we can use the <code>schedule</code> keyword,
followed by one or more intervals defined in <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/crontab.html#tag_20_25_07">POSIX syntax</a>, like in a <code>crontab</code>
file. For example, if we want our bot to run every night at midnight, we add:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">schedule</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#c6a0f6">cron</span>: <span style="color:#a6da95">&#34;0 0 * * *&#34;</span>
</span></span></code></pre></div><p>To also run the workflow every time an issue has activity, we add the <code>issues</code>
keyword, so that the previous snippet will look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">schedule</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#c6a0f6">cron</span>: <span style="color:#a6da95">&#34;0 0 * * *&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">issues</span>:
</span></span></code></pre></div><p>GitHub API sends different events for different things that happen to issues:
by leaving the <code>issues</code> mapping empty, we accept the defaults. You can
see what&rsquo;s the default for any value of the <code>on</code> keyword in the docs
<a href="https://help.github.com/en/articles/events-that-trigger-workflows#about-workflow-events">page about events</a>; in our case, the default value for <code>issues</code> is
<a href="https://help.github.com/en/articles/events-that-trigger-workflows#issues-event-issues">&ldquo;any possible kind of interaction&rdquo;</a> which is a bit too much.
That&rsquo;s not a problem because we can limit the kind of events that trigger our bot
by listing them explicitly in a sequence under the keyword <code>types</code>, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">schedule</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#c6a0f6">cron</span>: <span style="color:#a6da95">&#34;0 0 * * *&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">issues</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">types</span>: [edited, milestoned, labeled]
</span></span></code></pre></div><p>Our bot will be then summoned when an issue is edited, a milestone is added or a
label is attached. Since we also want the bot to be activated when somebody
leaves a comment on the issue, we need one more event on our <code>on</code> mapping,
specifically the <code>issue_comment</code> event:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">schedule</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#c6a0f6">cron</span>: <span style="color:#a6da95">&#34;0 0 * * *&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">issues</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">types</span>: [edited, milestoned, labeled]
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">issue_comment</span>:
</span></span></code></pre></div><p>The default <code>types</code> for the <code>issue_comment</code> event work for us, no need to add a
<code>types</code> keyword here.</p>
<h2 id="define-the-jobs">Define the jobs</h2>
<p>A Workflow consists of a set of <strong>jobs</strong> that will be run in parallel; each
job consists of a sequence of <strong>steps</strong> that will be run one after another.
We&rsquo;re going to define a single job named <code>stale-bot-logic</code> containing
one step for each requirement we have, for a total of three steps. Since we can
choose the platform on which our workflow will run, we pick Linux, specifically
<code>ubuntu-latest</code>. Let&rsquo;s add this to our workflow yaml definition:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">schedule</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#c6a0f6">cron</span>: <span style="color:#a6da95">&#34;0 0 * * *&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">issues</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">types</span>: [edited, milestoned, labeled]
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">issue_comment</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c6a0f6">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">stale-bot-logic</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">runs-on</span>: ubuntu-latest
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">steps</span>:
</span></span></code></pre></div><p>A step can either run a command on the host running the Workflow, or run a
Docker container or execute a special kind of node.js applications called <em>Actions</em>.
There are a lot of Actions available, ready to be included in a Workflow;
to have a better idea you can browse the GitHub <a href="https://github.com/marketplace">market place</a> - chances are
that somebody else already solved a problem you&rsquo;re having and no wheels will be
reinvented that day.</p>
<h3 id="mark-issue-stale">Mark issue stale</h3>
<p>The first step of the job will be marking an issue as stale after a certain
amount of time: this means we need to query the GitHub API and guess
what: there&rsquo;s an Action for that. The Action we need is called
<code>actions/github-script</code> and it&rsquo;ll be the only one we&rsquo;re going to use. It exposes
a Javascript client that can make API calls straight from the yaml code. The
Workflow will then look more or less like this (<code>on</code> section omitted for brevity):</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#c6a0f6">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">stale-bot</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">runs-on</span>: ubuntu-latest
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#c6a0f6">name</span>: Mark stale
</span></span><span style="display:flex;"><span>        <span style="color:#c6a0f6">uses</span>: actions/github-script@0.2.0
</span></span><span style="display:flex;"><span>        <span style="color:#c6a0f6">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#c6a0f6">github-token</span>: ${{ github.token }}
</span></span><span style="display:flex;"><span>          <span style="color:#c6a0f6">script</span>: // Here it goes some Javascript code that uses the GitHub API client
</span></span></code></pre></div><p>The <code>uses</code> keyword will tell the CI system we want to use a certain action at the
version <code>0.2.0</code>. Actions may expose few parameters you can use to configure their
behaviour (refer to each Action&rsquo;s docs for the details) and that&rsquo;s what the <code>with</code>
keyword is for: we&rsquo;ll pass in a valid GitHub token using the param <code>github-token</code>
and some Javascript code using the param <code>script</code>.</p>
<p>The logic for this job will be the following:</p>
<ol>
<li>Get a list of all open issues.</li>
<li>For each one, get the time and date of the last update.</li>
<li>If the difference between now and the last update for an issue is above a certain
threshold, attach a label called <code>stale</code> to it.</li>
</ol>
<p>The code will look like this (I&rsquo;ll paste only the job definition for brevity):</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#c6a0f6">name</span>: Mark stale
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">uses</span>: actions/github-script@0.2.0
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">with</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">github-token</span>: ${{github.token}}
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">script</span>: |<span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // Fetch the list of all open issues
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const opts = github.issues.listForRepo.endpoint.merge({
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        ...context.repo,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        state: &#39;open&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      });
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const issues = await github.paginate(opts);
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // How many days of inactivity before we mark the issue stale
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const elapsedDays = 30
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // Get the time window in milliseconds
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const elapsed = elapsedDays * 24 * 60 * 60 * 1000;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const now = new Date().getTime();
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      for (const issue of issues) {
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        // Ignore issues below the threshold
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        if (now - new Date(issue.updated_at).getTime() &lt; elapsed) {
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          continue;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        }
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        // If we got here, mark as stale.
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        github.issues.addLabels({
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          ...context.repo,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          issue_number: issue.number,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          labels: [&#39;stale&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        });
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      }</span>
</span></span></code></pre></div><p>That&rsquo;s pretty much all the code we need but there&rsquo;s one detail we need to take
care of: according to the <code>on</code> configuration we defined earlier, the Workflow
will run every day as a cron job and also every time an issue is updated. There&rsquo;s
no need to have the &ldquo;Mark Stale&rdquo; job run every time an issue is updated (obviously
an issue that gets updated is not stale) and we want to skip its execution in this
case. In other words, we want to run the step only when the Workflow was kicked
off by the cron scheduler. To do so, we can use the <code>if</code> keyword on our job:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#c6a0f6">name</span>: Mark stale
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">uses</span>: actions/github-script@0.2.0
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">if</span>: github.event_name == &#39;schedule&#39;
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">with</span>: ...
</span></span></code></pre></div><p>The job will be then skipped unless the statement in the <code>if</code> value is true.
That&rsquo;s Javascript code and you can access several objects called <em>contexts</em> from
there, in this case we&rsquo;re accessing the <code>event_name</code> field of the
<a href="https://help.github.com/en/articles/contexts-and-expression-syntax-for-github-actions#github-context"><code>github</code> context</a>.</p>
<h3 id="remove-stale-label">Remove stale label</h3>
<p>Sometimes a stale issue gets noticed and some activity kicks off again. In this
case, we need to remove the <code>stale</code> label as soon as possible. We use
the <code>github-script</code> Action again and this time we&rsquo;ll ask the CI system to
skip the job unless the source event is either an issue update or a new comment.
Note how we use a slightly more complex <code>if</code> clause here:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#c6a0f6">name</span>: Remove stale
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">if</span>: github.event_name == &#39;issues&#39; || github.event_name == &#39;issue_comment&#39;
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">uses</span>: actions/github-script@0.2.0
</span></span></code></pre></div><p>This time the logic will be the following:</p>
<ol>
<li>Get all the labels of the issue that triggered the Workflow.</li>
<li>Search whether it has a <code>stale</code> label and remove it.</li>
</ol>
<p>The final job definition will than be:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#c6a0f6">name</span>: Remove stale
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">if</span>: github.event_name == &#39;issues&#39; || github.event_name == &#39;issue_comment&#39;
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">uses</span>: actions/github-script@0.2.0
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">with</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">github-token</span>: ${{github.token}}
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">script</span>: |<span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // Fetch the list of labels attached to the issue that
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // triggered the workflow
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const opts = github.issues.listLabelsOnIssue.endpoint.merge({
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        ...context.repo,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        issue_number: context.issue.number
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      });
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const labels = await github.paginate(opts);
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      for (const label of labels) {
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        // If the issue has a label named &#39;stale&#39;, remove it
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        if (label.name === &#39;stale&#39;) {
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          await github.issues.removeLabel({
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">            ...context.repo,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">            issue_number: context.issue.number,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">            name: &#39;stale&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          })
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          return;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        }
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      }</span>
</span></span></code></pre></div><h3 id="close-stale">Close stale</h3>
<p>We&rsquo;ve one last job left to complete our stale bot: an issue should be closed in case
it&rsquo;s been marked as stale for a certain amount of time. The logic is the following:</p>
<ol>
<li>Load all the issues having the <code>stale</code> label attached.</li>
<li>For each one, compute the difference between now and the last update of the
issue (we assume it concides with the moment the <code>stale</code> label was added)</li>
<li>If the difference is above our threshold, close the issue.</li>
</ol>
<p>The job definition looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#c6a0f6">name</span>: Close stale
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">if</span>: github.event_name == &#39;schedule&#39;
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">uses</span>: actions/github-script@0.2.0
</span></span><span style="display:flex;"><span>  <span style="color:#c6a0f6">with</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">github-token</span>: ${{github.token}}
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">script</span>: |<span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // Fetch the list of all open issues that have the &#39;stale&#39; label
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // attached
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const opts = github.issues.listForRepo.endpoint.merge({
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        ...context.repo,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        state: &#39;open&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        labels: [&#39;stale&#39;],
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      });
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const issues = await github.paginate(opts);
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      // How many days of inactivity before we close a stale issue
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const elapsedDays = 15
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const elapsed = elapsedDays * 24 * 60 * 60 * 1000;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      const now = new Date().getTime();
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      for (const issue of issues) {
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        // Ignore issues below the threshold
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        if (now - new Date(issue.updated_at).getTime() &lt; elapsed) {
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          // This is how to print debug informations
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          console.log(&#39;skip issue &#39; + issue.number);
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          continue;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        }
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        // If we arrive here, the issue has to be closed
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        console.log(&#39;closing issue &#39; + issue.number);
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        await github.issues.update({
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          ...context.repo,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          issue_number: issue.number,
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">          state: &#39;closed&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">        });
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d">      }</span>
</span></span></code></pre></div><p>You can find the complete workflow <a href="https://github.com/masci/stalebot/blob/master/.github/workflows/stalebot.yml">here</a>.</p>
<h2 id="caveat-and-final-considerations">Caveat and final considerations</h2>
<figure><img src="/images/lenin-estrada-OI1ToozsKBw-unsplash.jpg"
    alt="A happier GitHub bot" width="100%"><figcaption>
      <h4>Photo by Lenin Estrada on Unsplash</h4>
    </figcaption>
</figure>

<p>First thing first, this bot shouldn&rsquo;t be considered feature complete by any mean,
the goal was just ramping up up on a new technology without getting bored. Now that
you&rsquo;re more familiar with GitHub Actions, a bunch of different and possibly more
efficient workflows to solve the same problems might have popped into your mind
already; if you need a stale bot for your project, I wouldn&rsquo;t see any problem
on keep going this way and make the implementation better.</p>
<p>That said, there&rsquo;s a subtle problem with this approach that I think it&rsquo;s worth
discussing: the code we wrote is just a piece of text defined in a yaml file that
GitHub will happily pass to the entrypoint of the <code>actions/github-script</code> action.
This means few terrible things:</p>
<ul>
<li>No syntax highlighting</li>
<li>No code validation</li>
<li>No tests</li>
</ul>
<p>Which can turn into respectively:</p>
<ul>
<li>A miserable user experience for authors and contributors</li>
<li>A frustrating development cycle</li>
<li>Bugs and poor performance</li>
</ul>
<p>This is actually very interesting because this problem can help us to better
define what the boundaries of a Workflow should be. I&rsquo;d phrase like this:</p>
<blockquote>
<p>If a workflow contains more than two lines of logic in plain text form, it&rsquo;s
time to write a custom Action.</p>
</blockquote>
<p>With a custom Action (whether Javascript or container based) you can
dramatically simplify the workflow definition while having tests and the
ability to exercise your code locally. You could also look at this problem
symmetrically:</p>
<blockquote>
<p>If your problem can be solved with two lines of logic, writing a custom Action
is probably overkill</p>
</blockquote>
<p>I&rsquo;m a big fun of custom Actions and I enjoy Typescript, but I have to say they
don&rsquo;t come for free: you basically need to write a full fledged
Node application and whether this is a problem or not, it&rsquo;s up to you.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>
  <hr class="footer"/>

  </main>
</body>

</html>
