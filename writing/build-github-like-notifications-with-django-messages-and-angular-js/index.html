<!doctype html>
<html lang="en-us">

<head>
  <title>Build GitHub like notifications with Django messages and AngularJS - /dev/ by Massimiliano Pippi</title>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.152.2">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Massimiliano Pippi" />
  <meta name="description" content="Build GitHub like notifications with Django messages and AngularJS" />
  <link rel="stylesheet" href="https://dev.pippi.im/css/main.min.66dc5ff1b2ffcc465c37385641ad836294f37f5f00dc4a10304ca1e7ad4f3979.css" />

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Build GitHub like notifications with Django messages and AngularJS">
  <meta name="twitter:description" content="Foreword GitHub has a very nice notification system, very similar to a plain old email inbox. You receive a notification which remains unread until you actually read it; then it’s archived and removed from your inbox, which it happens could remain empty:
For those who don’t know, Django ships a library for displaying “one-time” messages to the users, it’s called Message Framework and you can find it in the contrib package. Messages are produced during users’ activity and delivered subsequently; in the meantime, they are stored in cookies or sessions.">

  <meta property="og:url" content="https://dev.pippi.im/writing/build-github-like-notifications-with-django-messages-and-angular-js/">
  <meta property="og:site_name" content="/dev/ by Massimiliano Pippi">
  <meta property="og:title" content="Build GitHub like notifications with Django messages and AngularJS">
  <meta property="og:description" content="Foreword GitHub has a very nice notification system, very similar to a plain old email inbox. You receive a notification which remains unread until you actually read it; then it’s archived and removed from your inbox, which it happens could remain empty:
For those who don’t know, Django ships a library for displaying “one-time” messages to the users, it’s called Message Framework and you can find it in the contrib package. Messages are produced during users’ activity and delivered subsequently; in the meantime, they are stored in cookies or sessions.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="writing">
    <meta property="article:published_time" content="2013-10-22T00:00:00+00:00">
    <meta property="article:modified_time" content="2013-10-22T00:00:00+00:00">
    <meta property="article:tag" content="Django">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Angularjs">


</head>

<body>
  <header class="app-header">
    <a href="https://dev.pippi.im/"><img class="app-header-avatar"
        src="/images/massi.png"
        alt="John Doe" /></a>
    <h1>/about/</h1>
    <p>
      Massi here. Software developer, engineering manager, I can ops.
    Open source advocate and contributor, documentation fanatic, speaker at conferences.
    I wrote a book once.
    </p>
    <div>
      See what I'm up to <a href="/now">now</a>.
    </div>
    <div class="app-header-social">
      
      <a target="_blank" href="https://github.com/masci"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
      
      <a target="_blank" href="http://www.linkedin.com/in/masci"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
      
    </div>
  </header>
  <main class="app-container">
    
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Build GitHub like notifications with Django messages and AngularJS</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Oct 22, 2013
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          8 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://dev.pippi.im/tags/django/">Django</a><a class="tag" href="https://dev.pippi.im/tags/python/">Python</a><a class="tag" href="https://dev.pippi.im/tags/angularjs/">Angularjs</a></div></div>
    </header>
    <div class="post-content">
      <h2 id="foreword">Foreword</h2>
<p>GitHub has a very nice notification system, very similar to a plain old email inbox. You receive a notification which
remains <em>unread</em> until you actually read it; then it&rsquo;s archived and removed from your <em>inbox</em>, which it happens could remain empty:</p>
<p><img src="/images/github_notifications.png" alt="github inbox"></p>
<p>For those who don&rsquo;t know, Django ships a library for displaying &ldquo;one-time&rdquo; messages to the users, it&rsquo;s called <em>Message
Framework</em> and you can find it in the <code>contrib</code> package. Messages are <em>produced</em> during users&rsquo; activity and delivered
subsequently; in the meantime, they are stored in cookies or sessions.</p>
<p>The ephemeral nature of Django&rsquo;s <code>contrib.messages</code> makes them not suitable for storing notifications in GitHub
style: notifications have to be persisted until user actually reads it, messages instead are marked as read the moment
they are, let&rsquo;s say, <em>observed</em>. Nevertheless Django message framework is flexible enough to let you provide your own
storage policy, and third-party applications like <a href="https://github.com/evonove/django-stored-messages">Django Stored Messages</a>
use this feature to store messages in a persistent way (specifically, an sql database).</p>
<blockquote>
<p>Disclaimer: The frontend code will make use of AngularJs even if I am a total newbie and I don&rsquo;t really know how to
angular. If you are a newbie too, please go read <a href="http://toddmotto.com/ultimate-guide-to-learning-angular-js-in-one-day/">this effective blog post</a>
by Todd Motto and then come back here. If you&rsquo;re not an Angular newbie, please take into account my code could offend
you.</p>
</blockquote>
<h2 id="the-application">The application</h2>
<p>Fire up a virtualenv and install Django:</p>
<pre><code>mkvirtualenv notification_example
pip install django
</code></pre>
<p>Start an empty project:</p>
<pre><code>django-admin.py startproject notification_example
</code></pre>
<p>&hellip;and an app:</p>
<pre><code>cd notification_example
python manage.py startapp notification
</code></pre>
<p>Now for some dependencies - install Django Stored Messages and <a href="http://http://django-rest-framework.org/">Django Rest Framework</a>:</p>
<pre><code>pip install django-stored-messages djangorestframework
</code></pre>
<p>Configure all the things! In <code>notification_example/settings.py</code> be sure to have these:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    PROJECT_ROOT <span style="color:#91d7e3;font-weight:bold">=</span> os<span style="color:#91d7e3;font-weight:bold">.</span>path<span style="color:#91d7e3;font-weight:bold">.</span>join(os<span style="color:#91d7e3;font-weight:bold">.</span>path<span style="color:#91d7e3;font-weight:bold">.</span>abspath(os<span style="color:#91d7e3;font-weight:bold">.</span>path<span style="color:#91d7e3;font-weight:bold">.</span>dirname(<span style="color:#f4dbd6">__file__</span>)), <span style="color:#a6da95">&#39;..&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DATABASES <span style="color:#91d7e3;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;default&#39;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#a6da95">&#39;ENGINE&#39;</span>: <span style="color:#a6da95">&#39;django.db.backends.sqlite3&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6da95">&#39;NAME&#39;</span>: os<span style="color:#91d7e3;font-weight:bold">.</span>path<span style="color:#91d7e3;font-weight:bold">.</span>join(PROJECT_ROOT, <span style="color:#a6da95">&#39;db.sqlite&#39;</span>),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    INSTALLED_APPS <span style="color:#91d7e3;font-weight:bold">=</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;django.contrib.auth&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;django.contrib.contenttypes&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;django.contrib.sessions&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;django.contrib.sites&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;django.contrib.messages&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;django.contrib.staticfiles&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;notification&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;stored_messages&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6da95">&#39;rest_framework&#39;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MESSAGE_STORAGE <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#a6da95">&#39;stored_messages.storage.PersistentStorage&#39;</span>
</span></span></code></pre></div><p>Now let&rsquo;s go for some views. We will provide a view to serve the homepage, plus a view to show messages for the current
logged in user.</p>
<h2 id="the-homepage-view">The homepage view</h2>
<p>Django Stored Messages can persist messages only when they are sent to a valid user, and such user has to login for
viewing the messages, so we provide a login form directly inside the homepage. To produce some notifications, visiting the index will trigger a message as well. The code:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#8bd5ca">from</span> <span style="color:#f5a97f">django.views.generic</span> <span style="color:#8bd5ca">import</span> FormView
</span></span><span style="display:flex;"><span>    <span style="color:#8bd5ca">from</span> <span style="color:#f5a97f">django.contrib.auth.forms</span> <span style="color:#8bd5ca">import</span> AuthenticationForm
</span></span><span style="display:flex;"><span>    <span style="color:#8bd5ca">from</span> <span style="color:#f5a97f">django.contrib.messages</span> <span style="color:#8bd5ca">import</span> add_message
</span></span><span style="display:flex;"><span>    <span style="color:#8bd5ca">from</span> <span style="color:#f5a97f">django.contrib.auth</span> <span style="color:#8bd5ca">import</span> login
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8bd5ca">import</span> <span style="color:#f5a97f">stored_messages</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">class</span> <span style="color:#eed49f">IndexView</span>(FormView):
</span></span><span style="display:flex;"><span>        template_name <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#a6da95">&#39;notification/homepage.html&#39;</span>
</span></span><span style="display:flex;"><span>        form_class <span style="color:#91d7e3;font-weight:bold">=</span> AuthenticationForm
</span></span><span style="display:flex;"><span>        success_url <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#a6da95">&#39;/&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c6a0f6">def</span> <span style="color:#8aadf4">get_context_data</span>(<span style="color:#91d7e3">self</span>, <span style="color:#91d7e3;font-weight:bold">**</span>kwargs):
</span></span><span style="display:flex;"><span>            add_message(<span style="color:#91d7e3">self</span><span style="color:#91d7e3;font-weight:bold">.</span>request, stored_messages<span style="color:#91d7e3;font-weight:bold">.</span>STORED_INFO, <span style="color:#a6da95">&#39;You visited the homepage&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#c6a0f6">return</span> <span style="color:#91d7e3">super</span>(IndexView, <span style="color:#91d7e3">self</span>)<span style="color:#91d7e3;font-weight:bold">.</span>get_context_data(<span style="color:#91d7e3;font-weight:bold">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c6a0f6">def</span> <span style="color:#8aadf4">form_valid</span>(<span style="color:#91d7e3">self</span>, form):
</span></span><span style="display:flex;"><span>            login(<span style="color:#91d7e3">self</span><span style="color:#91d7e3;font-weight:bold">.</span>request, form<span style="color:#91d7e3;font-weight:bold">.</span>get_user())
</span></span><span style="display:flex;"><span>            <span style="color:#c6a0f6">return</span> <span style="color:#91d7e3">super</span>(IndexView, <span style="color:#91d7e3">self</span>)<span style="color:#91d7e3;font-weight:bold">.</span>form_valid(form)
</span></span></code></pre></div><p>We&rsquo;re going to use <em>class based views</em>, of course. Notice Django Stored Messages let us make use of the builtin
messages api, thus passing in a message of type <code>stored_messages.STORED_INFO</code> will cause that message to be stored on
the database.
The <a href="https://github.com/masci/notification_example/blob/master/templates/notification/homepage.html">homepage template</a>
will be extended from a <a href="https://github.com/masci/notification_example/blob/master/templates/base.html">basic Boostrap3 template</a>, we&rsquo;re going onto details later.</p>
<h2 id="the-message-view">The message view</h2>
<p>This is a simple <code>TemplateView</code>, the only trick here is getting from the urlstring whether user wants to see all the
notifications or only the <em>unread</em> ones:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#8bd5ca">from</span> <span style="color:#f5a97f">django.views.generic</span> <span style="color:#8bd5ca">import</span> TemplateView
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">class</span> <span style="color:#eed49f">MessagesView</span>(TemplateView):
</span></span><span style="display:flex;"><span>        template_name <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#a6da95">&#39;notification/messages.html&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c6a0f6">def</span> <span style="color:#8aadf4">get</span>(<span style="color:#91d7e3">self</span>, request, <span style="color:#91d7e3;font-weight:bold">*</span>args, <span style="color:#91d7e3;font-weight:bold">**</span>kwargs):
</span></span><span style="display:flex;"><span>            <span style="color:#c6a0f6">if</span> <span style="color:#a6da95">&#39;unread&#39;</span> <span style="color:#91d7e3;font-weight:bold">in</span> request<span style="color:#91d7e3;font-weight:bold">.</span>GET:  <span style="color:#6e738d;font-style:italic"># quick and dirty</span>
</span></span><span style="display:flex;"><span>                kwargs[<span style="color:#a6da95">&#39;unread&#39;</span>] <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#f5a97f">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c6a0f6">return</span> <span style="color:#91d7e3">super</span>(MessagesView, <span style="color:#91d7e3">self</span>)<span style="color:#91d7e3;font-weight:bold">.</span>get(request, <span style="color:#91d7e3;font-weight:bold">*</span>args, <span style="color:#91d7e3;font-weight:bold">**</span>kwargs)
</span></span></code></pre></div><p>The view code is rather simple because all the magic is left to Django Stored Messages template tags and its REST api.
The Html template for the message view will try to mimic GitHub&rsquo;s notification page,
<a href="https://github.com/masci/notification_example/blob/master/templates/notification/messages.html">here is the code</a> and
this is the result:</p>
<p><img src="/images/messages.png" alt="messages screenshot"></p>
<p>As you can see from this chunk:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    &lt;<span style="color:#c6a0f6">div</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;col-md-9&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    {% if not unread %}
</span></span><span style="display:flex;"><span>        {% stored_messages_archive 100 %}
</span></span><span style="display:flex;"><span>    {% else %}
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    {% endif %}
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#c6a0f6">div</span>&gt;
</span></span></code></pre></div><p>If user requested the archive (i.e. to show messages that were already read), the template tag
<code>stored_messages_archive</code> provided by Django Stored Messages will show a list of <code>100</code> messages rendering
the template at <code>stored_messages/stored_messages_list.html</code>. Here is the template ovverrided to add Bootstrap3 classes:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    {% if messages %}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#c6a0f6">ul</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;list-group&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            {% for message in messages %}
</span></span><span style="display:flex;"><span>                &lt;<span style="color:#c6a0f6">li</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;list-group-item&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                    {{ message.message }}
</span></span><span style="display:flex;"><span>                &lt;/<span style="color:#c6a0f6">li</span>&gt;
</span></span><span style="display:flex;"><span>            {% empty %}
</span></span><span style="display:flex;"><span>                &lt;<span style="color:#c6a0f6">li</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;list-group-item&#34;</span>&gt;No messages here!&lt;/<span style="color:#c6a0f6">li</span>&gt;
</span></span><span style="display:flex;"><span>            {% endfor %}
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#c6a0f6">ul</span>&gt;
</span></span><span style="display:flex;"><span>    {% endif %}
</span></span></code></pre></div><p>We will get into the details for the <code>else</code> branch in the messages template later.</p>
<h2 id="plug-the-urls">Plug the urls</h2>
<p>Nothing special here but notice the inclusion of the REST api urls coming from <code>stored_messages</code> package:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    urlpatterns <span style="color:#91d7e3;font-weight:bold">=</span> patterns(<span style="color:#a6da95">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>        url(<span style="color:#ed8796">r</span><span style="color:#a6da95">&#39;^logout/$&#39;</span>, <span style="color:#a6da95">&#39;django.contrib.auth.views.logout&#39;</span>,  {<span style="color:#a6da95">&#39;next_page&#39;</span>: <span style="color:#a6da95">&#39;/&#39;</span>}, name<span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#39;logout&#39;</span>),
</span></span><span style="display:flex;"><span>        url(<span style="color:#ed8796">r</span><span style="color:#a6da95">&#39;^$&#39;</span>, IndexView<span style="color:#91d7e3;font-weight:bold">.</span>as_view(), name<span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#39;home&#39;</span>),
</span></span><span style="display:flex;"><span>        url(<span style="color:#ed8796">r</span><span style="color:#a6da95">&#39;^messages/$&#39;</span>, MessagesView<span style="color:#91d7e3;font-weight:bold">.</span>as_view(), name<span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#39;messages&#39;</span>),
</span></span><span style="display:flex;"><span>        url(<span style="color:#ed8796">r</span><span style="color:#a6da95">&#39;^api/&#39;</span>, include(<span style="color:#a6da95">&#39;stored_messages.urls&#39;</span>)),
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><h2 id="final-touches">Final touches</h2>
<p>To add some noise to the notification stream, we will add messages for the user when she logs in and out:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#c6a0f6">def</span> <span style="color:#8aadf4">_user_logged_in</span>(<span style="color:#91d7e3;font-weight:bold">*</span>args, <span style="color:#91d7e3;font-weight:bold">**</span>kwargs):
</span></span><span style="display:flex;"><span>        add_message(kwargs[<span style="color:#a6da95">&#39;request&#39;</span>], stored_messages<span style="color:#91d7e3;font-weight:bold">.</span>STORED_INFO, <span style="color:#a6da95">&#39;You were logged in!&#39;</span>)
</span></span><span style="display:flex;"><span>    user_logged_in<span style="color:#91d7e3;font-weight:bold">.</span>connect(_user_logged_in)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c6a0f6">def</span> <span style="color:#8aadf4">_user_logged_out</span>(<span style="color:#91d7e3;font-weight:bold">*</span>args, <span style="color:#91d7e3;font-weight:bold">**</span>kwargs):
</span></span><span style="display:flex;"><span>        add_message(kwargs[<span style="color:#a6da95">&#39;request&#39;</span>], stored_messages<span style="color:#91d7e3;font-weight:bold">.</span>STORED_INFO, <span style="color:#a6da95">&#39;You were logged out!&#39;</span>)
</span></span><span style="display:flex;"><span>    user_logged_out<span style="color:#91d7e3;font-weight:bold">.</span>connect(_user_logged_out)
</span></span></code></pre></div><p>The Django app is complete now, time for some Javascript code!</p>
<h2 id="the-rest">The REST</h2>
<p>Even if Django Stored Messages has a template tag to show unread messages, for this demo we will use the REST api,
which let us retrieve unread messages and mark them as read. To interact with the api we use
<a href="http://angularjs.org/">Angular</a>, for the sake of simplicity we use a single controller:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#ed8796">var</span> messageApp <span style="color:#91d7e3;font-weight:bold">=</span> angular.module(<span style="color:#a6da95">&#39;messageApp&#39;</span>, []);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    messageApp.controller(<span style="color:#a6da95">&#39;MainCtrl&#39;</span>, [<span style="color:#a6da95">&#39;$scope&#39;</span>, <span style="color:#a6da95">&#39;$http&#39;</span>, <span style="color:#ed8796">function</span> ($scope, $http) {
</span></span><span style="display:flex;"><span>        <span style="color:#6e738d;font-style:italic">// Messages array
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>        $scope.messages <span style="color:#91d7e3;font-weight:bold">=</span> {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6e738d;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>    }]);
</span></span></code></pre></div><p>Notice the injection of the <code>$http</code> object we will use to make http requests. The messages array will be filled with
data coming from the api, then it will be available through the <code>$scope</code> object. For the angular application to work
properly, the html code in our templates needs to be aware of the angular stuff - we do this in the <code>base.html</code> so that
every page could use angular facilities:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#c6a0f6">html</span> <span style="color:#8aadf4">ng-app</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;messageApp&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#c6a0f6">head</span>&gt;
</span></span><span style="display:flex;"><span>        ...
</span></span></code></pre></div><p>and:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#c6a0f6">head</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#c6a0f6">body</span> <span style="color:#8aadf4">ng-controller</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;MainCtrl&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#6e738d;font-style:italic">&lt;!-- navbar --&gt;</span>
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#c6a0f6">div</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;navbar navbar-inverse navbar-fixed-top&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        ...
</span></span></code></pre></div><p>Inside the controller, this code will be added to retrieve all the unread messages for the logged-in user:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// retrieve Messages from the restAPI
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>    $http({
</span></span><span style="display:flex;"><span>        method<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>        url<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;//127.0.0.1:8000/api/inbox/&#39;</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .success(<span style="color:#ed8796">function</span> (data, status, headers, config) {
</span></span><span style="display:flex;"><span>        $scope.messages <span style="color:#91d7e3;font-weight:bold">=</span> data;
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .error(<span style="color:#ed8796">function</span> (data, status, headers, config) {
</span></span><span style="display:flex;"><span>        <span style="color:#6e738d;font-style:italic">// something went wrong :(
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// ...
</span></span></span></code></pre></div><p>If everything goes fine, <code>$scope.messages</code> will contain our messages and we can use them inside the DOM. To do this, we
need some angularities inside the html, for example in the <code>message.html</code> template:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    {% verbatim %}
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#c6a0f6">ul</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;list-group&#34;</span> <span style="color:#8aadf4">ng-if</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;messages.length&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#c6a0f6">li</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;list-group-item&#34;</span> <span style="color:#8aadf4">ng-repeat</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;message in messages&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {{ message.message.date | date:&#39;MMM d, y h:mm:ss a&#39; }} - {{ message.message.message }}
</span></span><span style="display:flex;"><span>          &lt;<span style="color:#c6a0f6">a</span> <span style="color:#8aadf4">ng-click</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;markRead($index)&#34;</span> <span style="color:#8aadf4">style</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;cursor:pointer&#34;</span>&gt;Mark as read&lt;/<span style="color:#c6a0f6">a</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#c6a0f6">li</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#c6a0f6">ul</span>&gt;
</span></span><span style="display:flex;"><span>    {% endverbatim %}
</span></span></code></pre></div><p>The <code>ng-if</code> attribute determines if we have some messages to show. If we do have, the <code>ng-repeat</code> attribute will take
care of iterating the messages and show them in the DOM through angular&rsquo;s template tags.</p>
<blockquote>
<p>Warning: we&rsquo;re mixing Django and Angular templates there and since they share the same template syntax (this could
be changed in angular but it&rsquo;s not generally advisable) we need to wrap angular code inside Django&rsquo;s <code>verbatim</code> tags.</p>
</blockquote>
<p>In the html code above notice this:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    &lt;<span style="color:#c6a0f6">a</span> <span style="color:#8aadf4">ng-click</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;markRead($index)&#34;</span> <span style="color:#8aadf4">style</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;cursor:pointer&#34;</span>&gt;Mark as read&lt;/<span style="color:#c6a0f6">a</span>&gt;
</span></span></code></pre></div><p>For every unread message, we provide a link and we tell angular that when user clicks it (<code>ng-click</code> attribute) the
function <code>markRead()</code> has to be called with the parameter <code>$index</code>. We define that function inside the angular
controller and attach it to the <code>$scope</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// mark messages read
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>    $scope.markRead <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#ed8796">function</span> (index) {
</span></span><span style="display:flex;"><span>        <span style="color:#ed8796">var</span> id <span style="color:#91d7e3;font-weight:bold">=</span> $scope.messages[index].id;
</span></span><span style="display:flex;"><span>        $http({
</span></span><span style="display:flex;"><span>            method<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;POST&#39;</span>,
</span></span><span style="display:flex;"><span>            url<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;//127.0.0.1:8000/api/inbox/&#39;</span><span style="color:#91d7e3;font-weight:bold">+</span>id<span style="color:#91d7e3;font-weight:bold">+</span><span style="color:#a6da95">&#39;/read/&#39;</span>,
</span></span><span style="display:flex;"><span>            xsrfHeaderName<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;X-CSRFToken&#39;</span>,
</span></span><span style="display:flex;"><span>            xsrfCookieName<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;csrftoken&#39;</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .success(<span style="color:#ed8796">function</span> (data, status, headers, config) {
</span></span><span style="display:flex;"><span>            $scope.messages.splice(index, <span style="color:#f5a97f">1</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .error(<span style="color:#ed8796">function</span> (data, status, headers, config) {
</span></span><span style="display:flex;"><span>            <span style="color:#6e738d;font-style:italic">// something went wrong :(
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>        })
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// ...
</span></span></span></code></pre></div><p>The parameter passed to <code>$http</code> contains all the logic needed to retrieve the csrf token from user&rsquo;s cookie and pass it
to Django inside the <code>X-CSRFToken</code> header. For my experience, I&rsquo;ve never seen an easier way to do this (thank you so
much, Angular!). After retrieving the database id for the <em>index-th</em> message, we call the <code>/api/inbox/{lookup}/read/</code>
endpoint which marks that message as read. In case the request goes well (and this is where magics happen), we remove
the element from the <code>$scope.messages</code> - angular will remove that element from the DOM afterwards. No code. No explicit
DOM manipulation. Just fun.</p>
<p>Since Django Stored Messages api exposes an endpoint to mark all messages read, we provide a button to do exactly this.
The code for the button is very similar to the one to mark messages read:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    &lt;<span style="color:#c6a0f6">button</span> <span style="color:#8aadf4">type</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;button&#34;</span> <span style="color:#8aadf4">class</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;btn btn-success&#34;</span> <span style="color:#8aadf4">ng-click</span><span style="color:#91d7e3;font-weight:bold">=</span><span style="color:#a6da95">&#34;markAllRead()&#34;</span>&gt;Mark all read&lt;/<span style="color:#c6a0f6">button</span>&gt;
</span></span></code></pre></div><p>This time the function name is <code>markAllRead</code> and we call it without parameters; the function is defined inside the
controller:</p>
<div class="highlight"><pre tabindex="0" style="color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// mark all read
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>    $scope.markAllRead <span style="color:#91d7e3;font-weight:bold">=</span> <span style="color:#ed8796">function</span> () {
</span></span><span style="display:flex;"><span>        $http({
</span></span><span style="display:flex;"><span>            method<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;POST&#39;</span>,
</span></span><span style="display:flex;"><span>            url<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;//127.0.0.1:8000/api/mark_all_read/&#39;</span>,
</span></span><span style="display:flex;"><span>            xsrfHeaderName<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;X-CSRFToken&#39;</span>,
</span></span><span style="display:flex;"><span>            xsrfCookieName<span style="color:#91d7e3;font-weight:bold">:</span> <span style="color:#a6da95">&#39;csrftoken&#39;</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .success(<span style="color:#ed8796">function</span>(data, status, headers, config) {
</span></span><span style="display:flex;"><span>            $scope.messages.splice(<span style="color:#f5a97f">0</span>, $scope.messages.length);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .error(<span style="color:#ed8796">function</span>(data, status, headers, config){
</span></span><span style="display:flex;"><span>            <span style="color:#6e738d;font-style:italic">// something went wrong :(
</span></span></span><span style="display:flex;"><span><span style="color:#6e738d;font-style:italic"></span>        })
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#6e738d;font-style:italic">// ...
</span></span></span></code></pre></div><p>The csrf boilerplate is the same (for the record, this could be easily avoided using some advanced angular features)
and the logic is very similar: in case the request succeeded, the array of messages is cleared and the DOM reflects the
changes automagically.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/masci/notification_example">A working example is on GitHub</a></li>
<li><a href="http://django-stored-messages.rtfd.org/">Django Stored Messages documentation</a></li>
</ul>

    </div>
    <div class="post-footer">
      
    </div>
  </article>
  <hr class="footer"/>

  </main>
</body>

</html>
